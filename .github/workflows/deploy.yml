name: Deploy Local Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy local Kubernetes
    runs-on: self-hosted

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Debug - ambiente do runner
        shell: powershell
        run: |
          Write-Host "===== DEBUG RUNNER ====="
          Write-Host "GITHUB_WORKSPACE: $env:GITHUB_WORKSPACE"
          Write-Host "Runner user (whoami):"
          whoami
          Write-Host ""

          Write-Host "Diretório atual:"
          Get-Location
          Write-Host ""

          Write-Host "Listando raiz do workspace:"
          Get-ChildItem -Path $env:GITHUB_WORKSPACE | Select-Object Name,Mode,LastWriteTime
          Write-Host ""

          Write-Host "kubectl version (client):"
          kubectl version --client
          Write-Host ""

          Write-Host "docker info (resumo):"
          docker info --format '{{.ServerVersion}}'
          Write-Host "========================"

      - name: Debug - procurar kubeconfig no disco
        shell: powershell
        run: |
          Write-Host "===== DEBUG KUBECONFIG ====="
          Write-Host "Checando caminhos comuns:"
          $paths = @(
            "C:\Users\Public\.kube\config",
            "C:\Windows\System32\config\systemprofile\.kube\config",
            "C:\ProgramData\DockerDesktop\pki\kubeconfig.yaml",
            "C:\ProgramData\DockerDesktop\pki\kubeconfig",
            "$env:USERPROFILE\.kube\config"
          )

          foreach ($p in $paths) {
            if (Test-Path $p) {
              Write-Host "✅ FOUND: $p"
            } else {
              Write-Host "❌ NOT FOUND: $p"
            }
          }

          Write-Host ""
          Write-Host "Procurando qualquer '.kube\config' (pode demorar um pouco)..."
          Get-ChildItem -Path C:\ -Recurse -Force -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -match "\\.kube\\config$" } |
            Select-Object -First 30 FullName

          Write-Host "============================="

      - name: Configurar kubeconfig (tentativa padrão)
        shell: powershell
        run: |
          $env:KUBECONFIG="C:\Users\Public\.kube\config"
          Write-Host "KUBECONFIG=$env:KUBECONFIG"
          if (!(Test-Path $env:KUBECONFIG)) {
            Write-Host "⚠️ kubeconfig padrão não existe. O step de debug acima vai mostrar o caminho correto."
          } else {
            Write-Host "✅ kubeconfig padrão encontrado."
          }

      - name: Garantir Kubernetes ativo
        shell: powershell
        run: |
          kubectl cluster-info

      - name: Executar deploy.ps1
        shell: powershell
        run: |
          cd infra-k8s
          .\deploy.ps1
