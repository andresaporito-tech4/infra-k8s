name: Deploy Local Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy local Kubernetes
    runs-on: self-hosted

    steps:
      # ---------------------------------------------------
      # 1️⃣ Checkout do código
      # ---------------------------------------------------
      - name: Checkout do código
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2️⃣ DEBUG - Mostrar usuário e diretórios
      # ---------------------------------------------------
      - name: Debug - ambiente do runner
        shell: powershell
        run: |
          Write-Host "USER: $env:USERNAME"
          Write-Host "HOME: $env:USERPROFILE"
          Write-Host "PWD:"
          Get-Location
          Write-Host "Conteúdo do workspace:"
          Get-ChildItem

      # ---------------------------------------------------
      # 3️⃣ CONFIGURAR KUBECONFIG (SOLUÇÃO DEFINITIVA)
      # ---------------------------------------------------
      - name: Configurar kubeconfig do Docker Desktop
        shell: powershell
        run: |
          $source = "C:\Users\Matheus\.kube\config"
          $targetDir = "C:\actions-runner\_kube"
          $target = "$targetDir\config"

          Write-Host "Procurando kubeconfig em: $source"

          if (-not (Test-Path $source)) {
            Write-Error "❌ kubeconfig do usuário NÃO encontrado em $source"
            exit 1
          }

          New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          Copy-Item $source $target -Force

          Write-Host "✅ kubeconfig copiado para $target"
          echo "KUBECONFIG=$target" >> $env:GITHUB_ENV

      # ---------------------------------------------------
      # 4️⃣ VALIDAR KUBERNETES
      # ---------------------------------------------------
      - name: Garantir Kubernetes ativo
        shell: powershell
        run: |
          kubectl version --client
          kubectl cluster-info

      # ---------------------------------------------------
      # 5️⃣ RODAR SCRIPT DE DEPLOY
      # ---------------------------------------------------
      - name: Deploy local Kubernetes
        shell: powershell
        run: |
          cd infra-k8s
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
          .\deploy.ps1
